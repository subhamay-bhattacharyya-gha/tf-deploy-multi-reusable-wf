name: Terraform Multi-Cloud Deploy

on:
  workflow_call:
    inputs:
      # Concurrency group name (optional - allows caller to customize)
      concurrency-group:
        description: "Concurrency group name for workflow runs"
        required: false
        type: string
        default: ""

      cloud-provider:
        description: "Target cloud provider or platform (aws, gcp, azure, snowflake, databricks, platform)"
        required: true
        type: string
      tflint-ver:
        description: "TFLint version to install"
        required: true
        type: string

      # Backend Type Selection
      backend-type:
        description: "Backend type to use: 's3' for AWS S3 or 'remote' for HCP Terraform Cloud."
        required: false
        type: string
        default: "s3"

      # AWS S3 Backend Configuration
      s3-bucket:
        description: "Name of the S3 bucket used as the backend for storing the Terraform state file. Required when backend-type is 's3'."
        required: false
        type: string

      s3-region:
        description: "AWS region where the S3 backend bucket is located (e.g., us-east-1, eu-west-1). Required when backend-type is 's3'."
        required: false
        type: string

      s3-key-prefix:
        description: "Optional prefix for the S3 state key (AWS only)."
        required: false
        type: string
        default: ""

      # AWS Authentication Inputs
      aws-region:
        description: "AWS region for authentication. Required when cloud-provider is 'aws'."
        required: false
        type: string

      # Snowflake Authentication Inputs
      snowflake-organization-name:
        description: "Snowflake organization name. Required when cloud-provider is 'snowflake'."
        required: false
        type: string

      snowflake-account-name:
        description: "Snowflake account name within the organization. Required when cloud-provider is 'snowflake'."
        required: false
        type: string

      snowflake-user:
        description: "Snowflake user name. Required when cloud-provider is 'snowflake'."
        required: false
        type: string

      snowflake-role:
        description: "Snowflake role name. Required when cloud-provider is 'snowflake'."
        required: false
        type: string

      # Terraform artifacts
      tf-vars-file:
        description: "Optional Terraform variable file"
        required: false
        type: string
        default: "terraform.tfvars"
    secrets:
      # HCP Terraform Cloud Secret
      tfc-token:
        description: "HCP Terraform Cloud API token. Required when backend-type is 'remote'."
        required: false

      # AWS Authentication Secret
      aws-role-to-assume:
        description: "AWS IAM role ARN to assume. Required when cloud-provider is 'aws'."
        required: false

      # GCP Authentication Secrets
      gcp-wif-provider:
        description: "GCP Workload Identity Federation provider. Required when cloud-provider is 'gcp'."
        required: false

      gcp-service-account:
        description: "GCP service account email for authentication. Required when cloud-provider is 'gcp'."
        required: false

      # Azure Authentication Secrets
      azure-client-id:
        description: "Azure client ID for authentication. Required when cloud-provider is 'azure'."
        required: false

      azure-tenant-id:
        description: "Azure tenant ID for authentication. Required when cloud-provider is 'azure'."
        required: false

      azure-subscription-id:
        description: "Azure subscription ID for authentication. Required when cloud-provider is 'azure'."
        required: false

      # Snowflake Authentication Secrets
      snowflake-private-key:
        description: "Snowflake private key for authentication. Required when cloud-provider is 'snowflake'."
        required: false

      # Databricks Authentication Secrets
      databricks-host:
        description: "Databricks workspace URL. Required when cloud-provider is 'databricks'."
        required: false

      databricks-token:
        description: "Databricks personal access token. Required when cloud-provider is 'databricks'."
        required: false

concurrency:
  group: ${{ inputs.concurrency-group || format('terraform-ci-{0}-{1}', inputs.cloud-provider, github.ref) }}
  cancel-in-progress: true
jobs:
  terraform-lint:
    name: ‚öôÔ∏è TFLint
    runs-on: ubuntu-latest
    
    steps:
      # Print all inputs for debug
      #############################################
      - name: Debug - Print All Inputs
        id: debug-inputs
        shell: bash
        run: |
          echo "=== DEBUG: All Action Inputs ==="
          echo "backend-type: ${{ inputs.backend-type }}"
          echo "cloud-provider: ${{ inputs.cloud-provider }}"
          echo "terraform-dir: infra/${{ inputs.cloud-provider }}/tf"
          echo "tflint-ver: ${{ inputs.tflint-ver }}"
          echo "tf-vars-file: ${{ inputs.tf-vars-file }}"
          echo ""
          echo "=== HCP Terraform Cloud Inputs ==="
          echo "tfc-token: [REDACTED - $(if [[ -n '${{ secrets.tfc-token }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo ""
          echo "=== AWS Authentication Inputs ==="
          echo "aws-region: ${{ inputs.aws-region }}"
          echo "aws-role-to-assume: [REDACTED - $(if [[ -n '${{ secrets.aws-role-to-assume }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo ""
          echo "=== GCP Authentication Inputs ==="
          echo "gcp-wif-provider: [REDACTED - $(if [[ -n '${{ secrets.gcp-wif-provider }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo "gcp-service-account: [REDACTED - $(if [[ -n '${{ secrets.gcp-service-account }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo ""
          echo "=== Azure Authentication Inputs ==="
          echo "azure-client-id: [REDACTED - $(if [[ -n '${{ secrets.azure-client-id }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo "azure-tenant-id: [REDACTED - $(if [[ -n '${{ secrets.azure-tenant-id }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo "azure-subscription-id: [REDACTED - $(if [[ -n '${{ secrets.azure-subscription-id }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo ""
          echo "=== Snowflake Authentication Inputs ==="
          echo "snowflake-organization-name: [REDACTED - $(if [[ -n '${{ inputs.snowflake-organization-name }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo "snowflake-account-name: [REDACTED - $(if [[ -n '${{ inputs.snowflake-account-name }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo "snowflake-user: [REDACTED - $(if [[ -n '${{ inputs.snowflake-user }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo "snowflake-role: [REDACTED - $(if [[ -n '${{ inputs.snowflake-role }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo "snowflake-private-key: [REDACTED - $(if [[ -n '${{ secrets.snowflake-private-key }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo ""
          echo "=== Databricks Authentication Inputs ==="
          echo "databricks-host: [REDACTED - $(if [[ -n '${{ secrets.databricks-host }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo "databricks-token: [REDACTED - $(if [[ -n '${{ secrets.databricks-token }}' ]]; then echo 'PROVIDED'; else echo 'NOT PROVIDED'; fi)]"
          echo "================================="

      # Validate input configuration
      #############################################
      - name: Validate Input Configuration
        id: validate-config
        shell: bash
        run: |
          # Validate backend-type input
          if [[ "${{ inputs.backend-type }}" != "s3" && "${{ inputs.backend-type }}" != "remote" ]]; then
            echo "Error: Invalid backend-type '${{ inputs.backend-type }}'. Must be either 's3' or 'remote'"
            exit 1
          fi
          echo "‚úÖ Valid backend-type: ${{ inputs.backend-type }}"

          # Validate cloud-provider input
          if [[ "${{ inputs.cloud-provider }}" != "aws" && "${{ inputs.cloud-provider }}" != "gcp" && "${{ inputs.cloud-provider }}" != "azure" && "${{ inputs.cloud-provider }}" != "snowflake" && "${{ inputs.cloud-provider }}" != "databricks" && "${{ inputs.cloud-provider }}" != "platform" ]]; then
            echo "Error: Invalid cloud-provider '${{ inputs.cloud-provider }}'. Must be one of: aws, gcp, azure, snowflake, databricks, platform"
            exit 1
          fi
          echo "‚úÖ Valid cloud-provider: ${{ inputs.cloud-provider }}"

          # Validate backend configuration
          if [[ "${{ inputs.backend-type }}" == "s3" ]]; then
            if [[ -z "${{ inputs.s3-bucket }}" || -z "${{ inputs.s3-region }}" ]]; then
              echo "Error: s3-bucket and s3-region are required when backend-type is 's3'"
              exit 1
            fi
          elif [[ "${{ inputs.backend-type }}" == "remote" ]]; then
            if [[ -z "${{ secrets.tfc-token }}" ]]; then
              echo "Error: tfc-token is required when backend-type is 'remote'"
              exit 1
            fi
            echo "Using existing backend configuration from Terraform files"
          fi

          # Validate cloud provider configuration
          case "${{ inputs.cloud-provider }}" in
            "aws")
              if [[ -z "${{ inputs.aws-region }}" || -z "${{ secrets.aws-role-to-assume }}" ]]; then
                echo "Error: aws-region and aws-role-to-assume are required when cloud-provider is 'aws'"
                exit 1
              fi
              ;;
            "gcp")
              if [[ -z "${{ secrets.gcp-wif-provider }}" || -z "${{ secrets.gcp-service-account }}" ]]; then
                echo "Error: gcp-wif-provider and gcp-service-account are required when cloud-provider is 'gcp'"
                exit 1
              fi
              ;;
            "azure")
              if [[ -z "${{ secrets.azure-client-id }}" || -z "${{ secrets.azure-tenant-id }}" || -z "${{ secrets.azure-subscription-id }}" ]]; then
                echo "Error: azure-client-id, azure-tenant-id, and azure-subscription-id are required when cloud-provider is 'azure'"
                exit 1
              fi
              ;;
            "snowflake")
              if [[ -z "${{ inputs.snowflake-organization-name }}" || -z "${{ inputs.snowflake-account-name }}" || -z "${{ inputs.snowflake-user }}" || -z "${{ inputs.snowflake-role }}" || -z "${{ secrets.snowflake-private-key }}" ]]; then
                echo "Error: snowflake-organization-name, snowflake-account-name, snowflake-user, snowflake-role, and snowflake-private-key are required when cloud-provider is 'snowflake'"
                exit 1
              fi
              ;;
            "databricks")
              if [[ -z "${{ secrets.databricks-host }}" || -z "${{ secrets.databricks-token }}" ]]; then
                echo "Error: databricks-host and databricks-token are required when cloud-provider is 'databricks'"
                exit 1
              fi
              ;;
            "platform")
              echo "Platform mode: Checking for cloud provider directories in infra/"
              VALIDATION_ERRORS=""

              # Check for AWS directory
              if [[ -d "infra/aws" ]]; then
                echo "Found infra/aws directory - validating AWS inputs..."
                if [[ -z "${{ inputs.aws-region }}" || -z "${{ secrets.aws-role-to-assume }}" ]]; then
                  VALIDATION_ERRORS="${VALIDATION_ERRORS}\n- AWS: aws-region and aws-role-to-assume are required"
                else
                  echo "  ‚úÖ AWS inputs validated"
                fi
              fi

              # Check for GCP directory
              if [[ -d "infra/gcp" ]]; then
                echo "Found infra/gcp directory - validating GCP inputs..."
                if [[ -z "${{ secrets.gcp-wif-provider }}" || -z "${{ secrets.gcp-service-account }}" ]]; then
                  VALIDATION_ERRORS="${VALIDATION_ERRORS}\n- GCP: gcp-wif-provider and gcp-service-account are required"
                else
                  echo "  ‚úÖ GCP inputs validated"
                fi
              fi

              # Check for Azure directory
              if [[ -d "infra/azure" ]]; then
                echo "Found infra/azure directory - validating Azure inputs..."
                if [[ -z "${{ secrets.azure-client-id }}" || -z "${{ secrets.azure-tenant-id }}" || -z "${{ secrets.azure-subscription-id }}" ]]; then
                  VALIDATION_ERRORS="${VALIDATION_ERRORS}\n- Azure: azure-client-id, azure-tenant-id, and azure-subscription-id are required"
                else
                  echo "  ‚úÖ Azure inputs validated"
                fi
              fi

              # Check for Snowflake directory
              if [[ -d "infra/snowflake" ]]; then
                echo "Found infra/snowflake directory - validating Snowflake inputs..."
                if [[ -z "${{ inputs.snowflake-organization-name }}" || -z "${{ inputs.snowflake-account-name }}" || -z "${{ inputs.snowflake-user }}" || -z "${{ inputs.snowflake-role }}" || -z "${{ secrets.snowflake-private-key }}" ]]; then
                  VALIDATION_ERRORS="${VALIDATION_ERRORS}\n- Snowflake: snowflake-organization-name, snowflake-account-name, snowflake-user, snowflake-role, and snowflake-private-key are required"
                else
                  echo "  ‚úÖ Snowflake inputs validated"
                fi
              fi

              # Check for Databricks directory
              if [[ -d "infra/databricks" ]]; then
                echo "Found infra/databricks directory - validating Databricks inputs..."
                if [[ -z "${{ secrets.databricks-host }}" || -z "${{ secrets.databricks-token }}" ]]; then
                  VALIDATION_ERRORS="${VALIDATION_ERRORS}\n- Databricks: databricks-host and databricks-token are required"
                else
                  echo "  ‚úÖ Databricks inputs validated"
                fi
              fi

              # Check if any validation errors occurred
              if [[ -n "$VALIDATION_ERRORS" ]]; then
                echo ""
                echo "Error: Missing required inputs for detected platforms:"
                echo -e "$VALIDATION_ERRORS"
                exit 1
              fi
              echo "All detected platform inputs validated successfully"
              ;;
          esac

      - name: Run TFLint
        uses: subhamay-bhattacharyya-gha/tf-lint-action@main
        with:
          tf-config-path: infra/${{ inputs.cloud-provider }}/tf
          tflint-ver: ${{ inputs.tflint-ver }}
          use-cache: "true"
          tflint-format: "compact"

  terraform-validate:
    name: ‚úÖ Validate
    runs-on: ubuntu-latest
    needs: 
      - terraform-lint

    steps:
      - name: Terraform Validate 
        uses: subhamay-bhattacharyya-gha/tf-validate-action@feature/GHA-0042-rename-github-action-inpu
        with:
          tf-config-path: infra/${{ inputs.cloud-provider }}/tf

  terraform-plan:
    name: üîç Plan
    runs-on: ubuntu-latest
    needs: 
      - terraform-validate

    steps:
      - name: Terraform Plan 
        uses: subhamay-bhattacharyya-gha/tf-plan-action@feature/GHA-0047-add-platform-based-multi
        env:
          DATABRICKS_HOST: ${{ secrets.databricks-host }}
          DATABRICKS_TOKEN: ${{ secrets.databricks-token }}
          SNOWFLAKE_ORGANIZATION_NAME: ${{ inputs.snowflake-organization-name }}
          SNOWFLAKE_ACCOUNT_NAME: ${{ inputs.snowflake-account-name }}
          SNOWFLAKE_USER: ${{ inputs.snowflake-user }}
          SNOWFLAKE_ROLE: ${{ inputs.snowflake-role }}
          SNOWFLAKE_PRIVATE_KEY: ${{ secrets.snowflake-private-key }}
        with:
          cloud-provider: ${{ inputs.cloud-provider }}
          tf-config-path: infra/${{ inputs.cloud-provider }}/tf
          backend-type: ${{ inputs.backend-type }}
          s3-bucket: ${{ inputs.s3-bucket }}
          s3-region: ${{ inputs.s3-region }}
          s3-key-prefix: ${{ inputs.s3-key-prefix }}
          tfc-token: ${{ secrets.tfc-token }}
          aws-region: ${{ inputs.aws-region }}
          aws-role-to-assume: ${{ secrets.aws-role-to-assume }}
          gcp-wif-provider: ${{ secrets.gcp-wif-provider }}
          gcp-service-account: ${{ secrets.gcp-service-account }}
          azure-client-id: ${{ secrets.azure-client-id }}
          azure-tenant-id: ${{ secrets.azure-tenant-id }}
          azure-subscription-id: ${{ secrets.azure-subscription-id }}
          tf-vars-file: ${{ inputs.tf-vars-file }}

  terraform-apply:
    name: üöÄ Apply
    runs-on: ubuntu-latest
    needs: 
      - terraform-plan

    steps:
      - name: Terraform Apply 
        uses: subhamay-bhattacharyya-gha/tf-apply-action@feature/GHA-0039-add-platform-based-multi
        env:
          TF_VAR_databricks_host: ${{ secrets.databricks-host }}
          TF_VAR_databricks_token: ${{ secrets.databricks-token }}
          TF_VAR_snowflake_organization_name: ${{ inputs.snowflake-organization-name }}
          TF_VAR_snowflake_account_name: ${{ inputs.snowflake-account-name }}
          TF_VAR_snowflake_user: ${{ inputs.snowflake-user }}
          TF_VAR_snowflake_role: ${{ inputs.snowflake-role }}
          TF_VAR_snowflake_private_key: ${{ secrets.snowflake-private-key }}
        with:
          cloud-provider: ${{ inputs.cloud-provider }}
          tf-config-path: infra/${{ inputs.cloud-provider }}/tf
          backend-type: ${{ inputs.backend-type }}
          s3-bucket: ${{ inputs.s3-bucket }}
          s3-region: ${{ inputs.s3-region }}
          s3-key-prefix: ${{ inputs.s3-key-prefix }}
          tfc-token: ${{ secrets.tfc-token }}
          aws-region: ${{ inputs.aws-region }}
          aws-role-to-assume: ${{ secrets.aws-role-to-assume }}
          gcp-wif-provider: ${{ secrets.gcp-wif-provider }}
          gcp-service-account: ${{ secrets.gcp-service-account }}
          azure-client-id: ${{ secrets.azure-client-id }}
          azure-tenant-id: ${{ secrets.azure-tenant-id }}
          azure-subscription-id: ${{ secrets.azure-subscription-id }}
          tf-vars-file: ${{ inputs.tf-vars-file }}
