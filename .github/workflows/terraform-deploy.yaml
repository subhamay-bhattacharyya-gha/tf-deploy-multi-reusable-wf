name: Terraform Multi-Cloud Deploy

on:
  workflow_call:
    inputs:
      cloud-provider:
        description: "Target cloud provider (aws, gcp, azure)"
        required: true
        type: string
      tflint-ver:
        description: "TFLint version to install"
        required: true
        type: string

jobs:
  terraform-lint:
    name: Terraform Deploy - ${{ inputs.cloud-provider }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Print Inputs
        run: |
          echo "=== Workflow Inputs ==="
          echo "Cloud Provider: ${{ inputs.cloud-provider }}"
          echo "TFLint Version: ${{ inputs.tflint-ver }}"
          echo "======================="

      - name: Validate Cloud Provider
        run: |
          if [[ "${{ inputs.cloud-provider }}" != "aws" && "${{ inputs.cloud-provider }}" != "gcp" && "${{ inputs.cloud-provider }}" != "azure" ]]; then
            echo "Error: Invalid cloud provider '${{ inputs.cloud-provider }}'. Must be one of: aws, gcp, azure"
            exit 1
          fi
          echo "Valid cloud provider: ${{ inputs.cloud-provider }}"

      - name: Run TFLint
        uses: subhamay-bhattacharyya-gha/tf-lint-action@feature/GHA-0030-add-debug-info-and-remove
        with:
          terraform-dir: infra/${{ inputs.cloud-provider }}/tf
          tflint-ver: ${{ inputs.tflint-ver }}
          use-cache: "true"
          tflint-format: "compact"

  terraform-validate:
    name: Terraform Validate - ${{ inputs.cloud-provider }}
    runs-on: ubuntu-latest

    steps:
      - name: Terraform Validate 
        uses: subhamay-bhattacharyya-gha/tf-validate-action@feature/GHA-0032-implement-terraform-state
        with:
          terraform-dir: infra/${{ inputs.cloud-provider }}/tf
